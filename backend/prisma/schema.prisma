// This is your Prisma schema file.
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//
// ENUMS
//

enum Role {
  CUSTOMER
  SELLER
  ENTERPRISE
  LOGISTICS
  SHIPPER
  ADMIN
}

// üëà ƒê√£ ƒë·ªïi t√™n 'PERCENT' -> 'PERCENTAGE', 'AMOUNT' -> 'FIXED_AMOUNT' cho r√µ nghƒ©a
enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

// üëà B·∫ÆT BU·ªòC: Th√™m enum cho Voucher
enum VoucherScope {
  SHOP     // Gi·∫£m gi√° c·ªßa ng∆∞·ªùi b√°n (Seller / Enterprise)
  PLATFORM // Gi·∫£m gi√° to√†n s√†n (Shopee)
  FREESHIP // Gi·∫£m ph√≠ v·∫≠n chuy·ªÉn
}

enum PaymentMethod {
  VNPAY
  PAYPAL
  COD
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}

enum OrderStatus {
  PENDING    // Ch·ªù thanh to√°n / x√°c nh·∫≠n
  PROCESSING // ƒê√£ x√°c nh·∫≠n, ch·ªù shop ƒë√≥ng g√≥i
  SHIPPING   // ƒêang giao h√†ng
  DELIVERED  // ƒê√£ giao th√†nh c√¥ng
  CANCELLED  // ƒê√£ h·ªßy
}

enum LogisticsStatus {
  CREATED    // ƒê∆°n h√†ng m·ªõi t·∫°o (ch·ªù shop x√°c nh·∫≠n)
  ASSIGNED   // ƒê√£ ph√¢n c√¥ng cho shipper
  PICKED_UP  // Shipper ƒë√£ l·∫•y h√†ng
  IN_TRANSIT // ƒêang giao h√†ng
  DELIVERED  // ƒê√£ giao h√†ng
  RETURNED   // Ho√†n tr·∫£
  CANCELLED  // H·ªßy
}

enum ShipperStatus {
  AVAILABLE // S·∫µn s√†ng nh·∫≠n ƒë∆°n
  BUSY      // ƒêang giao h√†ng
  OFFLINE   // Kh√¥ng ho·∫°t ƒë·ªông
}

enum BehaviorType {
  VIEW
  ADD_TO_CART
  PURCHASE
  SEARCH
}

enum PromotionType {
  FLASH_SALE
  CAMPAIGN
}

//
// MODELS
//

model User {
  id                String    @id @default(cuid())
  email             String    @unique
  password          String
  name              String
  avatar            String?
  phone             String?
  role              Role      @default(CUSTOMER) // üëà D√πng enum Role
  isVerified        Boolean   @default(false)
  verificationToken String?
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  seller            Seller?
  enterprise        Enterprise?
  logistics         LogisticsPartner?
  shipper           Shipper? // üëà Th√™m li√™n k·∫øt 1-1 v·ªõi Shipper
  addresses         Address[]
  orders            Order[]
  reviews           Review[]
  behaviors         UserBehavior[]
  voucherClaims     VoucherDistribution[] // üëà Voucher user ƒë√£ "l∆∞u"
}

model Address {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  label     String?
  fullName  String
  phone     String
  province  String
  district  String
  ward      String
  street    String
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//
// SELLER
//

model Seller {
  id                  String     @id @default(cuid())
  userId              String     @unique
  user                User       @relation(fields: [userId], references: [id])
  storeName           String
  verified            Boolean    @default(false)
  rating              Float?
  logoUrl             String?
  businessDocumentUrl String?
  identityDocumentUrl String?
  addressDocumentUrl  String?
  products            Product[]
  vouchers            Voucher[] // üëà Voucher do shop n√†y ph√°t h√†nh
}

//
// ENTERPRISE
//

model Enterprise {
  id                   String    @id @default(cuid())
  userId               String    @unique
  user                 User      @relation(fields: [userId], references: [id])
  companyName          String
  taxCode              String?
  verified             Boolean   @default(false)
  officialBrand        Boolean   @default(true)
  rating               Float?
  logoUrl              String?
  businessLicenseUrl   String?
  brandRegistrationUrl String?
  taxDocumentUrl       String?
  products             Product[]
  vouchers             Voucher[] // üëà Voucher do brand n√†y ph√°t h√†nh
}

//
// PRODUCT MANAGEMENT (ƒê√É T·ªêI ∆ØU H√ìA)
//

model Product {
  id           String      @id @default(cuid())
  name         String
  description  String
  categoryId   String
  category     Category    @relation(fields: [categoryId], references: [id])
  sellerId     String?
  seller       Seller?     @relation(fields: [sellerId], references: [id])
  enterpriseId String?
  enterprise   Enterprise? @relation(fields: [enterpriseId], references: [id])
  images       String[]    @default([])
  active       Boolean     @default(true)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  // üëà Gi√° v√† kho ƒë√£ chuy·ªÉn xu·ªëng Variant
  variants     ProductVariant[]
  reviews      Review[]
  orderItems   OrderItem[]
  behaviors    UserBehavior[]
  promotions   PromotionProduct[]
}

model ProductVariant {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  color     String?
  size      String?
  price     Float // üëà Gi√° g·ªëc c·ªßa bi·∫øn th·ªÉ
  stock     Int   // üëà T·ªìn kho c·ªßa bi·∫øn th·ªÉ
  sku       String? @unique
}

model Category {
  id         String              @id @default(cuid())
  name       String
  parentId   String?
  parent     Category?           @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children   Category[]          @relation("CategoryHierarchy")
  products   Product[]
  promotions PromotionCategory[]
}

model Review {
  id        String   @id @default(cuid())
  productId String
  userId    String
  rating    Int
  comment   String?
  createdAt DateTime @default(now())

  product Product @relation(fields: [productId], references: [id])
  user    User    @relation(fields: [userId], references: [id])
}

// üî¥ B·ªé Model `SellerProduct` v√¨ ƒë√£ t·ªëi ∆∞u theo m√¥ h√¨nh Shopee (Product thu·ªôc v·ªÅ 1 Seller)

//
// VOUCHER (ƒê√É X√ÇY D·ª∞NG L·∫†I THEO M√î H√åNH SHOPEE)
//

model Voucher {
  id               String       @id @default(cuid())
  code             String       @unique
  title            String
  description      String?
  scope            VoucherScope // üëà B·∫ÆT BU·ªòC: Ph√¢n lo·∫°i voucher
  discountType     DiscountType
  discountValue    Float
  maxDiscountValue Float? // üëà Gi·∫£m t·ªëi ƒëa
  minOrderValue    Float?
  startDate        DateTime
  endDate          DateTime
  usageLimit       Int?
  usedCount        Int          @default(0)
  isActive         Boolean      @default(true)

  // Li√™n k·∫øt ng∆∞·ªùi ph√°t h√†nh (Ch·ªâ c√≥ n·∫øu scope = SHOP)
  sellerId         String?
  enterpriseId     String?
  seller           Seller?      @relation(fields: [sellerId], references: [id])
  enterprise       Enterprise?  @relation(fields: [enterpriseId], references: [id])

  // Quan h·ªá ng∆∞·ª£c
  // üëà Quan h·ªá N-N v·ªõi Order (L∆∞u l·∫°i voucher ƒë√£ √°p d·ª•ng)
  orders           Order[]
  // üëà Voucher user ƒë√£ l∆∞u
  distributions    VoucherDistribution[]
  // üëà Ng√¢n s√°ch c·ªßa voucher (th∆∞·ªùng cho S√†n)
  budget           VoucherBudget?
}

// üëà B·∫ÆT BU·ªòC: Model l∆∞u voucher c·ªßa user
model VoucherDistribution {
  id        String   @id @default(cuid())
  voucherId String
  userId    String
  claimedAt DateTime @default(now())
  used      Boolean  @default(false)
  orderId   String?  // üëà N·ªëi v·ªõi ƒë∆°n h√†ng ƒë√£ s·ª≠ d·ª•ng voucher n√†y

  voucher Voucher @relation(fields: [voucherId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  // order     Order?    @relation(fields: [orderId], references: [id]) // (T√πy ch·ªçn)

  @@unique([voucherId, userId]) // User ch·ªâ claim 1 voucher 1 l·∫ßn
}

// üëà B·∫ÆT BU·ªòC: Model ng√¢n s√°ch voucher
model VoucherBudget {
  id          String  @id @default(cuid())
  voucherId   String  @unique // 1 voucher ch·ªâ c√≥ 1 ng√¢n s√°ch
  totalBudget Float   // t·ªïng ti·ªÅn gi·∫£m t·ªëi ƒëa
  usedBudget  Float   @default(0)
  voucher     Voucher @relation(fields: [voucherId], references: [id], onDelete: Cascade)
}

//
// ORDER & PAYMENT (ƒê√É C·∫¨P NH·∫¨T)
//

model Order {
  id               String       @id @default(cuid())
  userId           String
  user             User         @relation(fields: [userId], references: [id])
  status           OrderStatus  @default(PENDING)
  paymentId        String?      @unique
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  // üëà Gi√° tr·ªã ƒë∆°n h√†ng (ƒë√£ c·∫≠p nh·∫≠t)
  subtotal         Float // T·ªïng ti·ªÅn h√†ng g·ªëc
  shippingFee      Float // Ph√≠ ship g·ªëc
  shopDiscount     Float @default(0) // Ti·ªÅn gi·∫£m t·ª´ Shop Voucher
  platformDiscount Float @default(0) // Ti·ªÅn gi·∫£m t·ª´ Platform Voucher
  freeshipDiscount Float @default(0) // Ti·ªÅn gi·∫£m t·ª´ Freeship Voucher
  totalDiscount    Float // T·ªïng ti·ªÅn gi·∫£m (shop + platform)
  totalAmount      Float // T·ªïng cu·ªëi c√πng (subtotal - totalDiscount + shippingFee - freeshipDiscount)

  // üëà Quan h·ªá N-N v·ªõi Voucher (L∆∞u l·∫°i c√°c voucher ƒë√£ √°p d·ª•ng)
  appliedVouchers  Voucher[]

  payment          Payment?
  orderItems       OrderItem[]
  logisticsOrders  LogisticsOrder[]
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  productId String
  variantId String? // ID c·ªßa ProductVariant
  quantity  Int
  price     Float   // Gi√° c·ªßa s·∫£n ph·∫©m T·∫†I TH·ªúI ƒêI·ªÇM MUA

  // üëà B·∫ÆT BU·ªòC: Item n√†y c·ªßa shop n√†o?
  sellerId     String?
  enterpriseId String?

  order   Order   @relation(fields: [orderId], references: [id])
  product Product @relation(fields: [productId], references: [id])
}

model Payment {
  id            String        @id @default(cuid())
  orderId       String        @unique
  order         Order         @relation(fields: [orderId], references: [id])
  method        PaymentMethod
  status        PaymentStatus @default(PENDING)
  transactionId String?
  amount        Float // üëà Th√™m: S·ªë ti·ªÅn thanh to√°n
  createdAt     DateTime      @default(now())
}

//
// LOGISTICS (ƒê√É C·∫¨P NH·∫¨T)
//

model LogisticsPartner {
  id          String           @id @default(cuid())
  userId      String           @unique
  user        User             @relation(fields: [userId], references: [id])
  name        String
  apiEndpoint String?
  baseRate    Float
  rating      Float?
  verified    Boolean          @default(false)
  shippers    Shipper[]
  orders      LogisticsOrder[]
}

model Shipper {
  id                 String           @id @default(cuid())
  // üëà Li√™n k·∫øt v·ªõi User, x√≥a c√°c tr∆∞·ªùng tr√πng l·∫∑p
  userId             String           @unique
  user               User             @relation(fields: [userId], references: [id])
  logisticsPartnerId String
  logisticsPartner   LogisticsPartner @relation(fields: [logisticsPartnerId], references: [id])
  active             Boolean          @default(true)
  currentLocation    Json? // L∆∞u t·ªça ƒë·ªô lat, lng
  status             ShipperStatus    @default(AVAILABLE)
  rating             Float?
  totalDeliveries    Int              @default(0)
  totalRatings       Int              @default(0)
  deliveryRange      Float            @default(5.0) // Ph·∫°m vi giao h√†ng (km)
  assignedOrders     LogisticsOrder[]
  deliveryHistory    Json[] // L∆∞u l·ªãch s·ª≠ giao h√†ng
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  // ‚ùå X√≥a: email, password, name, phone, avatar (ƒë√£ c√≥ trong User)
}

model LogisticsOrder {
  id                 String           @id @default(cuid())
  orderId            String
  logisticsPartnerId String
  shipperId          String?
  trackingCode       String
  status             LogisticsStatus  @default(CREATED)
  pickupAddress      String // ƒê·ªãa ch·ªâ l·∫•y h√†ng
  deliveryAddress    String // ƒê·ªãa ch·ªâ giao h√†ng
  pickupLocation     Json? // T·ªça ƒë·ªô l·∫•y h√†ng
  deliveryLocation   Json? // T·ªça ƒë·ªô giao h√†ng
  distance           Float? // Kho·∫£ng c√°ch v·∫≠n chuy·ªÉn (km)
  estimatedTime      Int? // Th·ªùi gian d·ª± ki·∫øn (ph√∫t)
  estimatedDelivery  DateTime?
  pickupTime         DateTime?
  deliveredTime      DateTime?
  notes              String?
  deliveryAttempts   Int              @default(0)
  customerSignature  String? // Ch·ªØ k√Ω ng∆∞·ªùi nh·∫≠n
  proofOfDelivery    String[] // ·∫¢nh ch·ª©ng minh giao h√†ng
  updatedAt          DateTime         @updatedAt
  cancelReason       String?
  rating             Int? // ƒê√°nh gi√° t·ª´ kh√°ch h√†ng
  feedback           String? // Ph·∫£n h·ªìi t·ª´ kh√°ch h√†ng

  // üëà B·∫ÆT BU·ªòC: ƒê∆°n v·∫≠n n√†y l·∫•y h√†ng c·ªßa shop n√†o?
  sellerId           String?
  enterpriseId       String?

  order              Order            @relation(fields: [orderId], references: [id])
  logisticsPartner   LogisticsPartner @relation(fields: [logisticsPartnerId], references: [id])
  shipper            Shipper?         @relation(fields: [shipperId], references: [id])
}

//
// PERSONALIZATION
//

model UserBehavior {
  id        String       @id @default(cuid())
  userId    String
  productId String
  type      BehaviorType
  createdAt DateTime     @default(now())

  user    User    @relation(fields: [userId], references: [id])
  product Product @relation(fields: [productId], references: [id])
}

//
// PROMOTIONS
//

model Promotion {
  id                 String              @id @default(cuid())
  type               PromotionType
  name               String
  description        String?
  startDate          DateTime
  endDate            DateTime
  discountPercentage Float?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt

  products           PromotionProduct[]
  categories         PromotionCategory[]
}

model PromotionProduct {
  id                 String    @id @default(cuid())
  promotionId        String
  productId          String
  discountPercentage Float
  quantity           Int?
  soldQuantity       Int?      @default(0)

  promotion Promotion @relation(fields: [promotionId], references: [id])
  product   Product   @relation(fields: [productId], references: [id])
}

model PromotionCategory {
  id          String   @id @default(cuid())
  promotionId String
  categoryId  String

  promotion Promotion @relation(fields: [promotionId], references: [id])
  category  Category  @relation(fields: [categoryId], references: [id])
}